' 入力ファイル（予約リスト）
Const INPUT_PATH = "input.txt"
' 出力ファイル（ログ）
Const LOG_PATH = "log.txt"

Const SESSID = "9EE9C0452B13F3DF26"
Const ID = "27038790"
Const PASS = "WYDHF8VG"
Const MENSU = "1"
Const RIYOSHA = "20"

Dim fso
Dim r_file
Dim w_file
Dim buf
Dim objIE
Dim l_flg
Dim g_num
Dim t_num
Dim year
Dim month
Dim day
Dim retCode
Dim text

Set fso = CreateObject("Scripting.FileSystemObject")
Set r_file = fso.OpenTextFile(INPUT_PATH, 1, False, 0)
Set w_file = fso.OpenTextFile(LOG_PATH, 2, True)
Set objIE = CreateObject("InternetExplorer.Application")
objIE.Visible = True

l_flg = True
retCode = ""
text = ""

Do Until r_file.AtEndOfStream
	buf = r_file.ReadLine

	g_num = Mid(buf, 1, 2)
	year = Mid(buf, 3, 4)
	month = Mid(buf, 7, 2)
	day = Mid(buf, 9, 2)
	t_num = Mid(buf, 11, 1)

	' 初回もしくはセッションエラー時
	If (l_flg) Then
		' ログイン
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/menu/Login.cgi", "Referer: https://reserve.opas.jp/osakashi_k/Welcome.cgi;jsessionid=" & SESSID, "action=%83%8D%83O%83C%83%93&txtPassWord=" & PASS & "&txtProcId=%2Fmenu%2FLogin&txtRiyoshaCode=" & ID)
		
		' 種目選択
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/GenreSelect.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/GenreSelect.cgi", "action=%91I%91%F0%8C%88%92%E8&gamenNo=1&metaShubetsuCd=C00&shubetsuCd=C01&txtProcId=%2Fyoyaku%2FGenreSelect")

		l_flg = False
	End If


	' 体育館選択
	retCode = NameToCode(g_num)
	If (Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/ShisetsuMultiSelect.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/GenreSelect.cgi", "txtProcId=%2Fyoyaku%2FShisetsuMultiSelect&checkMeisaiUniqKey=" + NameToCode(g_num) + "&action=%91I%91%F0%8C%88%92%E8")
	Else
		retCode = retCode & "体育館選択"
	End If

	' 年月日選択
	If (Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/CalendarStatusSelect.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/ShisetsuMultiSelect.cgi", "txtProcId=%2Fyoyaku%2FCalendarStatusSelect&optYear=" & year & "&optMonth=" & month & "&optDay=" & day & "&action=%95%5C%8E%A6")
	End If

	' 時刻値取得
	If (Mid(retCode, 1, 2) <> "-1") Then
		retCode = NumToTime(objIE, t_num)
		If (Mid(retCode, 1, 2) <> "-1") Then
			target = Replace(NumToTime(objIE, t_num), ":", "%3A")
		Else
			retCode = retCode & "時刻値取得"
		End If
	End If

	' 時刻選択
	If (Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/CalendarStatusSelect.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/CalendarStatusSelect.cgi", "txtProcId=%2Fyoyaku%2FCalendarStatusSelect&hdCheckYoyakuStatus=" & target & "&hdCheckYoyakuStatus=" & target & "&checkYoyakuStatus=" & target & "&optYear=" & year & "&optMonth=" & month & "&optDay=" & day & "&action=%91I%91%F0%8C%88%92%E8")
	End If

	' 選択決定
	If (Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/ShinseiEntry.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/CalendarStatusSelect.cgi", "org.apache.struts.taglib.html.TOKEN=" & GetToken(objIE) & "&txtProcId=%2Fyoyaku%2FShinseiEntry&gamenNo=0&meisaiPageIndex=0&action=%91I%91%F0%8C%88%92%E8")
	End If

	MsgBox ""

	' 面数確定
	If (InStr(objIE.document.getElementsByTagName("form")(0).innerHTML, "面") <> 0 And Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/ShinseiEntry.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/ShinseiEntry.cgi", "action=%91I%91%F0%8C%88%92%E8&gamenNo=0&inputMensu=" & MENSU & "&meisaiPageIndex=0&org.apache.struts.taglib.html.TOKEN=" & GetToken(objIE) & "&txtProcId=%2Fyoyaku%2FShinseiEntry")
	End If

	' 利用者数確定
	If (Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/ShinseiEntry.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/ShinseiEntry.cgi", "org.apache.struts.taglib.html.TOKEN=" & GetToken(objIE) & "&txtProcId=%2Fyoyaku%2FShinseiEntry&gamenNo=1&meisaiPageIndex=0&numberOfRiyosha=" & RIYOSHA & "&action=%90%5C%8D%9E%93%E0%97e%8Am%92%E8")
	End If

	' 最終確定
	If (Mid(retCode, 1, 2) <> "-1") Then
		Call DoAction(objIE, "https://reserve.opas.jp/osakashi_k/yoyaku/PriceConfirm.cgi", "Referer: https://reserve.opas.jp/osakashi_k/yoyaku/ShinseiEntry.cgi", "org.apache.struts.taglib.html.TOKEN=" & GetToken(objIE) & "&txtProcId=%2Fyoyaku%2FPriceConfirm&meisaiPageIndex=0&chkRiyoKiyaku=1&action=%90%5C%8D%9E")
	End If
	
	' セッションエラー確認
	If (InStr(objIE.document.getElementsByTagName("form")(0).innerHTML, "セッションタイムアウト") <> 0) Then
		retCode = "-1_セッションエラー"
		l_flg = True
	End If


	If (Mid(retCode, 1, 2) <> "-1") Then
		retCode = "○"
	End If

	text = text & buf & "_" & retCode & vbCrLf
	retCode = ""
Loop

w_file.WriteLine text

r_file.Close
w_file.Close

' アクション
Sub DoAction(ByRef objIE, url, c_h_data, c_m_data)
	Dim h_data
	Dim m_data
	Dim common
		
	common = "Accept: text/html, application/xhtml+xml, image/jxr, */*" & vbCrLf & "Accept-Encoding: gzip, deflate" & vbCrLf & "Accept-Language: ja-JP" & vbCrLf & "Cache-Control: no-cache" & vbCrLf & "Connection: Keep-Alive" & vbCrLf & "Content-Type: application/x-www-form-urlencoded" & vbCrLf & "Host: reserve.opas.jp" & vbCrLf 
	h_data = common & c_h_data & vbCrLf
	m_data = TextToBin(c_m_data, "UTF-8")
	objIE.Navigate url, , , m_data, h_data

	Call IEWait(objIE)

End Sub

' TOKEN値の取得
Function GetToken(ByRef objIE)
	On Error Resume Next

	GetToken = objIE.document.getElementsByName("org.apache.struts.taglib.html.TOKEN")(0).value
	
	If err.number <> 0 Then
		GetToken = "-1_GetToken"
	End If
End Function

' 予約時間変換
Function NumToTime(ByRef objIE, Num)
	On Error Resume Next
	
	NumToTime = objIE.document.getElementsByTagName("tbody")(0).children(CInt(Num) - 1).children(0).children(0).value
	
	If err.number <> 0 Then
		NumToTime = "-1_NumToTime"
	End If
End Function

' 体育館コード変換
Function NameToCode(sNum)
	Select Case(sNum)
		' 丸善インテックアリーナ大阪（中央体育館）  サブアリーナ１／２面
		Case "01"
			NameToCode = "271004_001_01_02_02_002_002"
		' 千島体育館  体育場１／２面
		Case "02"
			NameToCode = "271004_001_02_01_02_001_002"
		' フィットネス２１東淀川体育館  体育場１／２面
		Case "03"
			NameToCode = "271004_001_03_01_02_001_002"
		' 北スポーツセンター  第１体育場
		Case "04"
			NameToCode = "271004_001_13_01_01_001_001"
		' 都島スポーツセンター  第１体育場
		Case "05"
			NameToCode = "271004_001_14_01_01_001_001"
		' 都島スポーツセンター  第２体育場
		Case "06"
			NameToCode = "271004_001_14_02_01_002_001"
		' 福島スポーツセンター  体育場
		Case "07"
			NameToCode = "271004_001_15_01_01_001_001"
		' フィットネス２１此花スポーツセンター  第１体育場
		Case "08"
			NameToCode = "271004_001_16_01_01_001_001"
		' 中央スポーツセンター  第１体育場
		Case "09"
			NameToCode = "271004_001_17_01_01_001_001"
		' 西スポーツセンター  第１体育場
		Case "10"
			NameToCode = "271004_001_18_01_01_001_001"
		' 港スポーツセンター  第１体育場１／２面
		Case "11"
			NameToCode = "271004_001_19_01_01_001_001"
		' 港スポーツセンター  第２体育場
		Case "12"
			NameToCode = "271004_001_19_02_01_002_001"
		' 大正スポーツセンター  第１体育場１／２面
		Case "13"
			NameToCode = "271004_001_20_01_01_001_001"
		' 大正スポーツセンター  第２体育場
		Case "14"
			NameToCode = "271004_001_20_02_01_002_001"
		' 天王寺スポーツセンター  第１体育場１／２面
		Case "15"
			NameToCode = "271004_001_21_01_01_001_001"
		' 天王寺スポーツセンター  第２体育場
		Case "16"
			NameToCode = "271004_001_21_02_01_002_001"
		' 明治スポーツプラザ浪速スポーツセンター  第１体育場１／２面
		Case "17"
			NameToCode = "271004_001_22_01_01_001_001"
		' 明治スポーツプラザ浪速スポーツセンター  第２体育場
		Case "18"
			NameToCode = "271004_001_22_02_01_002_001"
		' サンエイワーク西淀川スポーツセンター  体育場
		Case "19"
			NameToCode = "271004_001_23_01_01_001_001"
		' 淀川スポーツセンター  第１体育場
		Case "20"
			NameToCode = "271004_001_24_01_01_001_001"
		' 淀川スポーツセンター  第２体育場
		Case "21"
			NameToCode = "271004_001_24_02_01_002_001"
		' 東淀川スポーツセンター  第１体育場１／２面
		Case "22"
			NameToCode = "271004_001_25_01_01_001_001"
		' 東成スポーツセンター  第１体育場１／２面
		Case "23"
			NameToCode = "271004_001_26_01_01_001_001"
		' 東成スポーツセンター  第２体育場
		Case "24"
			NameToCode = "271004_001_26_02_01_002_001"
		' 生野スポーツセンター  第１体育場
		Case "25"
			NameToCode = "271004_001_27_01_01_001_001"
		' 旭スポーツセンター  第１体育場
		Case "26"
			NameToCode = "271004_001_28_01_01_001_001"
		' 城東スポーツセンター  第１体育場１／２面
		Case "27"
			NameToCode = "271004_001_29_01_01_001_001"
		' 城東スポーツセンター  第２体育場
		Case "28"
			NameToCode = "271004_001_29_02_01_002_001"
		' 鶴見スポーツセンター  第１体育場
		Case "29"
			NameToCode = "271004_001_30_01_01_001_001"
		' サンエイワーク阿倍野スポーツセンター  第１体育場１／２面
		Case "30"
			NameToCode = "271004_001_31_01_01_001_001"
		' 住之江スポーツセンター  第１体育場
		Case "31"
			NameToCode = "271004_001_32_01_01_001_001"
		' サンエイワーク住吉スポーツセンター  第１体育場１／２面
		Case "32"
			NameToCode = "271004_001_33_01_01_001_001"
		' 東住吉スポーツセンター  第１体育場１／２面
		Case "33"
			NameToCode = "271004_001_34_01_01_001_001"
		' ＨＳＴ平野スポーツセンター  第１体育場１／２面
		Case "34"
			NameToCode = "271004_001_35_01_01_001_001"
		' ＨＳＴ西成スポーツセンター  第１体育場１／２面
		Case "35"
			NameToCode = "271004_001_36_01_01_001_001"
		' ＨＳＴ西成スポーツセンター  第２体育場
		Case "36"
			NameToCode = "271004_001_36_02_01_002_001"
		' ＨＳＴ扇町プール  体育場
		Case "37"
			NameToCode = "271004_001_37_01_01_001_001"
		Case Else
			NameToCode = "-1_NameToCode"
	End Select
End Function

' 文字コード変換（変換元データ, "UTF-8" or "UTF-16")
Function TextToBin(TextData, CharSet)
	Const adTypeBinary = 1
	Const adTypeText = 2 
	Dim objStream
	Set objStream = CreateObject("ADODB.Stream")
	objStream.Type = adTypeText 
	objStream.Charset = CharSet 
	objStream.Open 
	objStream.WriteText TextData
	objStream.Position = 0 
	objStream.Type = adTypeBinary 
	
	Select Case UCase(CharSet) 
		Case "UNICODE","UTF-16" 
			objStream.Position = 2 
		Case "UTF-8" 
			objStream.Position = 3 
	End Select
	
	TextToBin = objStream.Read 
	objStream.Close 
	Set objStream = Nothing 

End Function

' ブラウザ表示待ち
Sub IEWait(ByRef objIE)
	Do While objIE.Busy = True Or objIE.readyState <> 4
		WScript.Sleep 100
	Loop
End Sub

https://translate.google.co.jp/translate?hl=ja&sl=en&tl=ja&u=https%3A%2F%2Fmathieularose.com%2Fdecoding-captchas%2F
